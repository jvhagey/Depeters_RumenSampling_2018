#-----------------------------------------------------------kneaddata for QC----------------------------------------------------------#
#!/bin/bash
##
#SBATCH -p intel
#SBATCH --mem=30G
#SBATCH --time=18:0:0
#SBATCH -n 15
#SBATCH -o /share/magalab/Jill/Depeters/Kneaddata/kneaddata.out
#SBATCH -e /share/magalab/Jill/Depeters/Kneaddata/kneaddata.err
module load bowtie2/2.3.4.1
module load fastqc/0.11.7
module load trimmomatic/0.33
module load trf/4.0.9

#note that to run this there are some issues with current code base and Python3.
#The issue is discussed here:  https://bitbucket.org/biobakery/kneaddata/issues/8/error-during-reformatting-of-sequence
#And a fix can be found here to edit the code base: https://bitbucket.org/biobakery/kneaddata/commits/dbc99e91f332
kneaddata --bypass-trim --input /share/magalab/Jill/Depeters/Raw/20161213-MMDR_S1_L001_R1_001.fastq.gz --input /share/magalab/Jill/Depeters/Raw/20161213-MMDR_S1_L001_R2_001.fastq.gz -t 15 -db /share/magalab/bin/Fastq_Screen_Index/Cow_Genome_ARS-UCD1.2_Index/ -db /share/magalab/bin/Fastq_Screen_Index/Phage_Index/ -db /share/magalab/bin/Fastq_Screen_Index/Cow_Mito_Index/ -db /share/magalab/bin/Fastq_Screen_Index/Human_Index/ --output /share/magalab/Jill/Depeters/Kneaddata/ --run-fastqc-start --run-fastqc-end

#----------------------------------------------------CutAdapt for demultiplexing----------------------------------------------------------#
#!/bin/bash
##
#SBATCH -p intel
#SBATCH --time=1-0:0:0
#SBATCH --mem=10G
#SBATCH -o /share/magalab/Jill/Depeters/CutAdapt/cutadapt.out
#SBATCH -e /share/magalab/Jill/Depeters/CutAdapt/cutadapt.err

cd /share/magalab/Jill/Depeters/CutAdapt/
ulimit -n 1200
#This will just demultiplex
#time cutadapt -a file:/share/magalab/CDRF_2018/Raw/barcodes.fa --untrimmed-o no_barcodes_R1.fastq.gz --untrimmed-p no_barcodes_R2.fastq.gz -o {name}_R1.fastq.gz -p {name}_R2.fastq.gz /share/magalab/CDRF_2018/Raw/201804-CDRF2_S1_L001_R1_001.fastq /share/magalab/CDRF_2018/Raw/201804-CDRF2_S1_L001_R2_001.fastq
#This demultiplexes and removes primers.

time cutadapt -a file:/share/magalab/Jill/Depeters/Raw/barcodes.fa --no-trim --untrimmed-o no_barcodes_R1.fastq.gz --untrimmed-p no_barcodes_R2.fastq.gz -o {name}_R1.fastq.gz -p {name}_R2.fastq.gz /share/magalab/Jill/Depeters/Kneaddata/20161213-MMDR_S1_L001_R1_001_kneaddata_paired_1.fastq /share/magalab/Jill/Depeters/Kneaddata/20161213-MMDR_S1_L001_R1_001_kneaddata_paired_2.fastq

#----------------------------------------------------CutAdapt to trim off primers and barcodes------------------------------------------#
for f in /share/magalab/Jill/Depeters/CutAdapt/*_R1.fastq.gz
do
	fname=$(basename $f _R1.fastq.gz)
	echo $fname
	echo "#!/bin/bash" > $fname.CutAdapt.sh
	echo "##" >> $fname.CutAdapt.sh
	echo "#SBATCH -p intel" >> $fname.CutAdapt.sh
	echo "#SBATCH --mem=10G" >> $fname.CutAdapt.sh
	echo "#SBATCH --time=18:0:0" >> $fname.CutAdapt.sh
	echo "#SBATCH -o /share/magalab/Jill/Depeters/CutAdapt/Error_Out/${fname}_trim_cutadapt.out" >> $fname.CutAdapt.sh
	echo "#SBATCH -e /share/magalab/Jill/Depeters/CutAdapt/Error_Out/${fname}_trim_cutadapt.err" >> $fname.CutAdapt.sh
	echo "cd /share/magalab/Jill/Depeters/CutAdapt/No_Prime/" >> $fname.CutAdapt.sh
	echo "time cutadapt -a GTGTGCCAGCMGCCGCGGTAA...ATTAGAWACCCBDGTAGTCCGG -A CCGGACTACHVGGGTWTCTAAT...TTACCGCGGCKGCTGGCACAC -o ${fname}_Trim_R1.fastq.gz -p ${fname}_Trim_R2.fastq.gz /share/magalab/Jill/Depeters/CutAdapt/${fname}_R1.fastq.gz /share/magalab/Jill/Depeters/CutAdapt/${fname}_R2.fastq.gz" >> $fname.CutAdapt.sh
sbatch $fname.CutAdapt.sh
done
